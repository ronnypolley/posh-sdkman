name: Pester

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: read

jobs:
   test-pwsh:
     strategy:
       fail-fast: false
       matrix:
         platform: [ubuntu-latest, macos-latest, windows-latest]
     runs-on: ${{ matrix.platform }}
     steps:
     - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

     - name: Run Pester tests (pwsh)
       run: |
         dir env:
         Write-host $PSVersionTable.PSVersion.Major $PSVersionTable.PSRemotingProtocolVersion.Minor
         Install-Module -Name Pester -RequiredVersion 5.7.1 -Confirm:$false -Force
         Set-Location -Path .\Tests\
         Invoke-Pester
         if ($Error[0].Fullyqualifiederrorid -eq 'PesterAssertionFailed') {exit 1}
       shell: pwsh

   test-posh:
     runs-on: windows-latest
     steps:
     - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
     - name: Run Pester tests (PowerShell)
       run: |
         Write-host $PSVersionTable.PSVersion.Major $PSVersionTable.PSRemotingProtocolVersion.Minor
         Install-Module -Name Pester -RequiredVersion 5.7.1 -Confirm:$false -Force
         $pesterConfig = New-PesterConfiguration
         $pesterConfig.CodeCoverage.Enabled = $true
         $pesterConfig.CodeCoverage.Path="..\PSSDKMan\"
         $pesterConfig.TestResult.Enabled = $true
         $pesterConfig.Run.PassThru = $true
         Set-Location -Path .\Tests\
         Invoke-Pester -Configuration $pesterConfig | Export-JUnitReport -Path .\testResults.xml
         if ($Error[0].Fullyqualifiederrorid -eq 'PesterAssertionFailed') {exit 1}
       shell: powershell
     - name: Upload coverage reports to Codecov
       uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
       with:
         token: ${{ secrets.CODECOV_TOKEN }}
     - name: Upload test results to Codecov
       if: ${{ !cancelled() }}
       uses: codecov/test-results-action@f2dba722c67b86c6caa034178c6e4d35335f6706 # v1.1.0
       with:
         token: ${{ secrets.CODECOV_TOKEN }}
