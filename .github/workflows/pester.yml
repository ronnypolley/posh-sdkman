name: Pester

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: read

jobs:
   test-pwsh:
     strategy:
       fail-fast: false
       matrix:
         platform: [ubuntu-latest, macos-latest, windows-latest]
     runs-on: ${{ matrix.platform }}
     steps:
     - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

     - name: Run Pester tests (pwsh)
       run: |
         dir env:
         Write-host $PSVersionTable.PSVersion.Major $PSVersionTable.PSRemotingProtocolVersion.Minor
         Install-Module -Name Pester -RequiredVersion 5.7.1 -Confirm:$false -Force
         Set-Location -Path .\Tests\
         Invoke-Pester
         if ($Error[0].Fullyqualifiederrorid -eq 'PesterAssertionFailed') {exit 1}
       shell: pwsh

   test-posh:
     runs-on: windows-latest
     steps:
     - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
     - name: Run Pester tests (PowerShell)
       run: |
         Write-host $PSVersionTable.PSVersion.Major $PSVersionTable.PSRemotingProtocolVersion.Minor
         Install-Module -Name Pester -RequiredVersion 5.7.1 -Confirm:$false -Force
         $pesterConfig = New-PesterConfiguration
         $pesterConfig.CodeCoverage.Enabled = $true
         $pesterConfig.CodeCoverage.Path="..\PSSDKMan\"
         $pesterConfig.TestResult.Enabled = $true
         $pesterConfig.Run.PassThru = $true
         Set-Location -Path .\Tests\
         Invoke-Pester -Configuration $pesterConfig | Export-JUnitReport -Path .\testResults.xml
         if ($Error[0].Fullyqualifiederrorid -eq 'PesterAssertionFailed') {exit 1}
       shell: powershell
     - name: Upload coverage reports to Codecov
       uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
       with:
         token: ${{ secrets.CODECOV_TOKEN }}
     - name: Upload test results to Codecov
       if: ${{ !cancelled() }}
       uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # v1.2.1
       with:
         token: ${{ secrets.CODECOV_TOKEN }}
